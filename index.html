<html>
<head>
<title>Colorize Gist</title>
<meta name="color-scheme" content="dark light">
<style>
/* Thanks Solarized for nice colors
   https://ethanschoonover.com/solarized/
 */
:root {
  --base03: #002b36;
  --base02: #073642;
  --base00: #657b83;
  --base0: #839496;
  --base2: #eee8d5;
  --base3: #fdf6e3;
  --red: #dc322f;
  --blue: #268bd2;
  --cyan: #2aa198;
  --green: #859900;

  /* default dark */
  --background: var(--base03);
  --background-highlight: var(--base02);
  --body-text: var(--base0);
}

@media (prefers-color-scheme: light) {
  :root {
    --background: var(--base3);
    --background-highlight: var(--base2);
    --body-text: var(--base00);
  }
}

.red { color: var(--red); }
.green { color: var(--green); }
.blue { color: var(--blue); }
.cyan { color: var(--cyan); }
.reset { color: var(--body-text); }

html {
  background-color: var(--background);
  color: var(--body-text);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
    "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans",
    "Helvetica Neue", Arial, sans-serif;
}

a { color: var(--blue); }

code, pre {
  /* Nice font via: https://qwtel.com/posts/software/the-monospaced-system-ui-css-font-stack/ */
  font-family: ui-monospace, Menlo, Monaco, "Cascadia Mono", "Segoe UI Mono",
    "Roboto Mono", "Oxygen Mono", "Ubuntu Monospace", "Source Code Pro",
    "Fira Mono", "Droid Sans Mono", "Courier New", monospace;
}

code {
  display: block;
  margin: 1rem;
  padding: 1rem;
  background-color: var(--background-highlight);
}

.instructions {
  margin: auto;
  max-width: 60rem;
  display: none;
}

#gistContent:empty + .instructions {
  display: block;
}

.controls {
  position: fixed;
  bottom: 40px;
  right: 40px;
  user-select: none;
}

#back { text-decoration: none; }
#back:not([data-hash]) { display: none; }

#error {
  color: var(--red);
  margin: .25rem 0;
}

</style>
<script>
function replacePrefix(str, prefix, replacement) {
  return str.startsWith(prefix) ? `${replacement}${str.slice(prefix.length)}` : str;
}

// convert to "/raw" github URL - hosted on a different domain with permissive CORS
function rawGistUrl(url) {
  url = replacePrefix(url, 'https://gist.github.com', 'https://gist.githubusercontent.com')
  if (!url.startsWith('https://gist.githubusercontent.com')) { return null; }
  if (!url.includes('/raw')) { url += '/raw' }
  return url;
}

function load(url) {
  const $gistContent = document.getElementById('gistContent');
  $gistContent.innerHTML = "";
  const rawUrl = rawGistUrl(url);

  if (!rawUrl) {
    const $err = document.getElementById('error');
    $err.innerHTML = 'Not a Gist URL';
    return;
  }

  document.title = `Colorize gist - ${url}`

  fetch(rawUrl).then(response => response.text()).then((content) => {
    const value = content
      // don't treat content from the page as html
      .replaceAll('<', ' &lt;')
      .replaceAll('>', ' &gt;')
      // the stupidest possible way to render these ansi color escapes.
      // Relies on the browser to auto-close all the spans at the end of
      // the document for us ðŸ˜…
      .replaceAll('\u001b[31m', '<span class="red">')
      .replaceAll('\u001b[32m', '<span class="green">')
      .replaceAll('\u001b[34m', '<span class="blue">')
      .replaceAll('\u001b[36m', '<span class="cyan">')
      .replaceAll('\u001b[39m', '<span class="reset">');
    $gistContent.innerHTML = `<pre>${value}</pre>`;
  });
};

window.addEventListener('hashchange', (evt) => {
  if ((window.location.hash || '').length < 2) {
    window.location.reload();
  }

  load(window.location.hash.slice(1));
  $back = document.getElementById('back');
  $back.setAttribute('data-hash', window.location.hash)
})

window.addEventListener('load', () => {
  if (window.location.hash) {
    load(window.location.hash.slice(1));
    $back = document.getElementById('back');
    $back.setAttribute('data-hash', window.location.hash)
  }

  gistUrl.focus();

  document.getElementById('form').addEventListener('submit', (e) => {
    e.preventDefault();
    window.location.hash = gistUrl.value;
  });
})
</script>
</head>
<body>
<div id="app">
  <div id="gistContent"></div>
  <div class="instructions">
    <h2>ANSI escape code color renderer</h2>
    <p>
      Using the <a href="https://cli.github.com/">Github CLI</a>, capture the output
      you want to share into a gist:
    </p>
    <code>
      <span class="green">$</span> some-command | gh gist create -
    </code>
    <p>
      Then paste that gist's URL below.
    </p>
    <form id="form">
      <label>Gist URL<br><input id="gistUrl" name="gistUrl" /></label>
      <button>Go</button>
      <div id="error"></div>
    </form>
  </div>
</div>
<div class="controls">
  <a href="#" id="back">&#x1f519;</a>
</div>
</div>
</body>
</html>
